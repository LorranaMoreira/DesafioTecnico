unit Compras;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.ComCtrls, Vcl.StdCtrls,
  Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Banco;

type
  TTelaCompras = class(TForm)
    PnlFundo: TPanel;
    EbData: TLabel;
    LbNumCompra: TLabel;
    LbProduto: TLabel;
    LbQuantidade: TLabel;
    LbValorUnit: TLabel;
    LbDescItem: TLabel;
    LbValorTotal: TLabel;
    PnlDivisao: TPanel;
    PnlGrid: TPanel;
    LbItensCompras: TLabel;
    GridCompras: TDBGrid;
    PnlTotalCompra: TPanel;
    LbTotalCompra: TLabel;
    EdNumCompra: TEdit;
    EdVlrUnit: TEdit;
    EdQuantidade: TEdit;
    EdProduto: TEdit;
    EdDesconto: TEdit;
    EdValorTotal: TEdit;
    BtnSelecionar: TButton;
    BtnAdicionar: TButton;
    BtnLimpar: TButton;
    BtnFinalizar: TButton;
    EdTotalCompra: TEdit;
    DTPData: TDateTimePicker;

    procedure FormCreate(Sender: TObject);
    procedure BtnAdicionarClick(Sender: TObject);
    procedure BtnLimparClick(Sender: TObject);
    procedure BtnFinalizarClick(Sender: TObject);
    procedure EdProdutoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure GridComprasDblClick(Sender: TObject);
  private
    procedure GerarNumeroCompra;
    procedure CalcularTotalItem;
    procedure AtualizarTotalCompra;
    function ValidarItem: Boolean;
    procedure AtualizarStatusFinalizar;
  public
    { Public declarations }
  end;

var
  TelaCompras: TTelaCompras;

implementation

{$R *.dfm}

uses PesqProdutos;

procedure TTelaCompras.FormCreate(Sender: TObject);
begin
  GerarNumeroCompra;
  DTPData.Date := Date;
  EdTotalCompra.Text := '0,00';
  EdNumCompra.Enabled := False;   // desabilita edição do número da compra
  BtnFinalizar.Enabled := False;  // só habilita quando houver itens
end;

procedure TTelaCompras.GerarNumeroCompra;
begin
  with DataModule1.QryCompras do
  begin
    Close;
    SQL.Clear;
    SQL.Text := 'SELECT COALESCE(MAX(ID),0)+1 AS PROXIMO FROM COMPRAS';
    Open;
    EdNumCompra.Text := FieldByName('PROXIMO').AsString;
  end;
end;

procedure TTelaCompras.CalcularTotalItem;
var
  Qtd: Integer;
  VlrUnit, Desc, Total: Double;
begin
  Qtd := StrToIntDef(EdQuantidade.Text, 0);
  VlrUnit := StrToFloatDef(EdVlrUnit.Text, 0);
  Desc := StrToFloatDef(EdDesconto.Text, 0);

  Total := (Qtd * VlrUnit) - Desc;
  EdValorTotal.Text := FormatFloat('0.00', Total);
end;

function TTelaCompras.ValidarItem: Boolean;
begin
  Result := False;

  if Trim(EdProduto.Text) = '' then
  begin
    ShowMessage('Selecione um produto.');
    Exit;
  end;

  if StrToIntDef(EdQuantidade.Text, 0) <= 0 then
  begin
    ShowMessage('A quantidade deve ser maior que zero.');
    Exit;
  end;

  Result := True;
end;

procedure TTelaCompras.BtnAdicionarClick(Sender: TObject);
begin
  if not ValidarItem then Exit;

  CalcularTotalItem;

  with DataModule1.QryItensCompra do
  begin
    Append;
    FieldByName('NUM_COMPRA').AsInteger := StrToInt(EdNumCompra.Text);
    FieldByName('PRODUTO').AsString := EdProduto.Text;
    FieldByName('QTD').AsInteger := StrToInt(EdQuantidade.Text);
    FieldByName('VL_UNIT').AsFloat := StrToFloat(EdVlrUnit.Text);
    FieldByName('DESC_ITEM').AsFloat := StrToFloatDef(EdDesconto.Text, 0);
    FieldByName('VL_TOTAL').AsFloat := StrToFloat(EdValorTotal.Text);
    Post;
  end;

  AtualizarTotalCompra;
  AtualizarStatusFinalizar;
end;

procedure TTelaCompras.AtualizarTotalCompra;
begin
  with DataModule1.QryItensCompra do
  begin
    Close;
    SQL.Clear;
    SQL.Text := 'SELECT SUM(VL_TOTAL) AS TOTAL FROM ITENS_COMPRA WHERE NUM_COMPRA = :NUM';
    ParamByName('NUM').AsInteger := StrToInt(EdNumCompra.Text);
    Open;
    EdTotalCompra.Text := FormatFloat('0.00', FieldByName('TOTAL').AsFloat);
  end;
end;

procedure TTelaCompras.AtualizarStatusFinalizar;
begin
  BtnFinalizar.Enabled := (StrToFloatDef(EdTotalCompra.Text, 0) > 0);
end;

procedure TTelaCompras.BtnLimparClick(Sender: TObject);
begin
  EdProduto.Clear;
  EdQuantidade.Clear;
  EdVlrUnit.Clear;
  EdDesconto.Clear;
  EdValorTotal.Clear;
end;

procedure TTelaCompras.BtnFinalizarClick(Sender: TObject);
begin
  if not BtnFinalizar.Enabled then Exit;

  try
    with DataModule1.QryCompras do
    begin
      Close;
      SQL.Clear;
      SQL.Text :=
        'INSERT INTO COMPRAS (ID, DATA, TOTAL) ' +
        'VALUES (:ID, :DATA, :TOTAL)';
      ParamByName('ID').AsInteger := StrToInt(EdNumCompra.Text);
      ParamByName('DATA').AsDate := DTPData.Date;
      ParamByName('TOTAL').AsFloat := StrToFloat(EdTotalCompra.Text);
      ExecSQL;
    end;

    ShowMessage('Compra finalizada com sucesso!');

  except
    on E: Exception do
      ShowMessage('Insira ao menos um produto para finalizar a compra.');
  end;
end;

procedure TTelaCompras.EdProdutoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_F2 then
  begin
    if not Assigned(PesqsProdutos) then
      PesqsProdutos := TPesqsProdutos.Create(Application);
    PesqsProdutos.ShowModal;
  end;
end;

procedure TTelaCompras.GridComprasDblClick(Sender: TObject);
begin
  if not DataModule1.QryItensCompra.IsEmpty then
  begin
    if MessageDlg('Deseja excluir este item da compra?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
    begin
      DataModule1.QryItensCompra.Delete;
      AtualizarTotalCompra;
      AtualizarStatusFinalizar;
    end;
  end;
end;

end.
