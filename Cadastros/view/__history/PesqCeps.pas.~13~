unit PesqCeps;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Data.DB,
  Vcl.StdCtrls, Vcl.Grids, Vcl.DBGrids, Banco;

type
  TPesqsCeps = class(TForm)
    PnlFundo: TPanel;
    BtnSelecionar: TButton;
    GridCeps: TDBGrid;
    DataSource1: TDataSource;
    LbCeps: TLabel;
    procedure FormShow(Sender: TObject);
    procedure BtnSelecionarClick(Sender: TObject);
    procedure GridCepsDblClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    procedure PreencherCadastro;
    procedure ConfigurarGrid;
  public
  end;

var
  PesqsCeps: TPesqsCeps;

implementation

uses CadsCep;

{$R *.dfm}

procedure TPesqsCeps.ConfigurarGrid;
begin
  GridCeps.Columns.Clear;

  with GridCeps.Columns.Add do
  begin
    FieldName     := 'CEP';
    Title.Caption := 'CEP';
    Width         := 90;
  end;

  with GridCeps.Columns.Add do
  begin
    FieldName     := 'LOGRADOURO';
    Title.Caption := 'Logradouro';
    Width         := 200;
  end;

  with GridCeps.Columns.Add do
  begin
    FieldName     := 'CIDADE';
    Title.Caption := 'Cidade';
    Width         := 130;
  end;

  with GridCeps.Columns.Add do
  begin
    FieldName     := 'UF';
    Title.Caption := 'UF';
    Width         := 40;
  end;
end;

procedure TPesqsCeps.FormShow(Sender: TObject);
begin
  try
    DataSource1.DataSet := DataModule1.QryCep;
    GridCeps.DataSource := DataSource1;

    with DataModule1.QryCep do
    begin
      Close;
      SQL.Clear;
      SQL.Text :=
        'SELECT ID, CEP, LOGRADOURO, CIDADE, UF ' +
        'FROM CEP ORDER BY CEP';
      Open;
    end;

    ConfigurarGrid;
  except
    on E: Exception do
      ShowMessage('Erro ao carregar CEPs: ' + E.Message);
  end;
end;

procedure TPesqsCeps.PreencherCadastro;
begin
  if DataModule1.QryCep.IsEmpty then
  begin
    ShowMessage('Nenhum CEP selecionado.');
    Exit;
  end;

  CadastroCep.EdCEP.Text        := DataModule1.QryCep.FieldByName('CEP').AsString;
  CadastroCep.EdLogradouro.Text := DataModule1.QryCep.FieldByName('LOGRADOURO').AsString;
  CadastroCep.EdCidade.Text     := DataModule1.QryCep.FieldByName('CIDADE').AsString;
  CadastroCep.CbUF.Text         := DataModule1.QryCep.FieldByName('UF').AsString;
end;

procedure TPesqsCeps.BtnSelecionarClick(Sender: TObject);
begin
  PreencherCadastro;
  ModalResult := mrOk;
end;

procedure TPesqsCeps.GridCepsDblClick(Sender: TObject);
begin
  BtnSelecionarClick(Sender);
end;

procedure TPesqsCeps.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  GridCeps.DataSource := nil;
  DataSource1.DataSet := nil;
  DataModule1.QryCep.Close;
  Action    := caFree;
  PesqsCeps := nil;
end;

end.
